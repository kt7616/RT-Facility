# 技術仕様書 — 北日本 放射線治療施設アクセスマップ

## 1. 目的と対象範囲

本プロジェクトは、北日本（北海道・東北6県・新潟県、計8道県）における放射線治療施設へのアクセス時間を可視化するWebアプリケーションである。1km四方の人口メッシュごとに最寄りの放射線治療施設への自動車走行時間を推計し、地図上に色分け表示する。利用者は施設の有効・無効を切り替えることで、施設の増減が地域住民のアクセシビリティに与える影響をシミュレーションできる。

対象とする道県は以下の8つである。JIS都道府県コード（2桁、ゼロ埋め）で管理する。

| コード | 道県名 | 英語名 | GADM NAME_1 |
|--------|--------|--------|-------------|
| 01 | 北海道 | hokkaido | Hokkaido |
| 02 | 青森県 | aomori | Aomori |
| 03 | 岩手県 | iwate | Iwate |
| 04 | 宮城県 | miyagi | Miyagi |
| 05 | 秋田県 | akita | Akita |
| 06 | 山形県 | yamagata | Yamagata |
| 07 | 福島県 | fukushima | Fukushima |
| 15 | 新潟県 | niigata | Niigata |

---

## 2. 全体のデータフロー

処理は大きく「前処理パイプライン」（R言語）と「Webアプリケーション」（HTML/CSS/JavaScript）に分かれる。

前処理パイプラインは以下の順序で実行される。

1. e-Stat（政府統計の総合窓口）から令和2年国勢調査の1kmメッシュ別人口データをダウンロードし、道県別にZIPを展開する。
2. 展開したCSVファイルからメッシュコードと総人口を抽出し、メッシュ中心座標を算出する。施設マスタCSVを読み込み、各道県のメッシュに対して自県および隣接県の施設すべてを目的地としてOSRM table APIに問い合わせ、所要時間行列（秒単位）を取得する。
3. GADM v4.1の行政境界GeoJSONをダウンロードし、道県別に市区町村と県境界を抽出する。
4. すべての中間データをJSON/GeoJSON形式に変換し、data/ディレクトリに書き出す。

Webアプリケーションはdata/ディレクトリのJSONファイルを読み込み、Leaflet.jsを用いて地図上にメッシュポリゴンを描画する。サーバは不要であり、静的ファイルのホスティング（GitHub Pages等）で動作する。

---

## 3. 施設マスタ

施設一覧はpreprocessing/facilities.csvに保持する。このCSVが施設データの唯一のソースである。列は以下の通り。

- **id**: 一意の連番整数。
- **name**: 施設名（日本語）。Webアプリでの表示名およびOSRM計算結果の列名として使用する。
- **pref_code**: 施設が所在する都道府県のJISコード（2桁ゼロ埋め）。
- **pref_name**: 都道府県名（日本語）。
- **lat**: 緯度（WGS84、十進法）。
- **lon**: 経度（WGS84、十進法）。
- **address**: 所在地住所。参照用であり処理には使用しない。
- **source**: 座標の取得方法を示す文字列。manual（手動設定）、nominatim（Nominatim API）など。
- **notes**: 自由テキスト。座標補正の経緯などを記録する。

施設を追加する場合は、このCSVに行を追加し、前処理パイプラインを再実行する。pref_codeが対象8道県のいずれかであれば、該当道県および隣接道県のOSRM計算に自動的に反映される。

---

## 4. 隣接道県の定義

各道県のメッシュに対するOSRM所要時間計算では、その道県に所在する施設だけでなく、隣接道県の施設も目的地に含める。これにより、県境付近の住民が隣県の施設を利用するケースを考慮できる。

隣接関係は以下の通り。

- 01 北海道: なし（陸路で他県と接しない）
- 02 青森県: 03 岩手県, 05 秋田県
- 03 岩手県: 02 青森県, 04 宮城県, 05 秋田県, 06 山形県
- 04 宮城県: 03 岩手県, 05 秋田県, 06 山形県, 07 福島県
- 05 秋田県: 02 青森県, 03 岩手県, 04 宮城県, 06 山形県
- 06 山形県: 03 岩手県, 04 宮城県, 05 秋田県, 07 福島県, 15 新潟県
- 07 福島県: 04 宮城県, 06 山形県, 15 新潟県
- 15 新潟県: 06 山形県, 07 福島県

---

## 5. メッシュコードの仕様

人口メッシュはJIS X 0410に準拠した第3次地域メッシュ（標準地域メッシュ、1km四方）を使用する。メッシュコードは8桁の数値文字列で、各桁の意味は以下の通り。

8桁コードを AABBCDEF と表記する。

- AA（1-2桁目）: 緯度方向の1次メッシュ番号。
- BB（3-4桁目）: 経度方向の1次メッシュ番号。経度は BB+100 度が基準。
- C（5桁目）: 2次メッシュの緯度位置（0-7）。
- D（6桁目）: 2次メッシュの経度位置（0-7）。
- E（7桁目）: 3次メッシュの緯度位置（0-9）。
- F（8桁目）: 3次メッシュの経度位置（0-9）。

メッシュ南西端の座標は次式で求まる。
- 緯度 = AA / 1.5 + C / 12 + E / 120
- 経度 = (BB + 100) + D / 8 + F / 80

メッシュの大きさは緯度方向が 1/120 度、経度方向が 1/80 度である。中心座標はそれぞれ 1/240 度、1/160 度を加算して求める。

---

## 6. e-Stat人口データの読み込み

e-Stat統計地理情報システムから「令和2年国勢調査 — 移動人口の男女・年齢等集計」（統計表ID: T001100）のメッシュ別データをダウンロードする。ダウンロードURLのパターンは以下の通り。

    https://www.e-stat.go.jp/gis/statmap-search/data?statsId=T001100&code={都道府県コード}&downloadType=2

ZIPファイルを展開するとタブ区切りテキストファイル（CP932エンコーディング）が得られる。使用する列は以下の2つ。

- KEY_CODE: 8桁のメッシュコード。
- T001100001: 総人口。

秘匿処理フラグがある行や人口が0以下の行は除外する。

---

## 7. OSRM（経路計算エンジン）の構成

### ルーティングプロファイル

OSRMのカスタムLuaプロファイル（car_jp_medical.lua）を使用する。速度設定は松田ら(2018)「医療計画作成支援データブック」に準拠する。主な速度設定は以下の通り。

| 道路種別 | OSMタグ | 設定速度 |
|----------|---------|---------|
| 高速道路 | motorway | 80 km/h |
| IC/JCTランプ | motorway_link | 50 km/h |
| 一般国道 | trunk | 50 km/h |
| 主要地方道 | primary | 50 km/h |
| 県道・市道 | secondary | 40 km/h |
| 一般道 | tertiary, unclassified | 30 km/h |
| 細街路 | residential | 20 km/h |
| 生活道路 | living_street | 10 km/h |

交差点通過ペナルティは6秒、信号機ペナルティも6秒、Uターンペナルティは20秒とする。日本の左側通行に対応する設定を有効にする。なお、OSMタグに記載されたmaxspeedは使用せず、上記プロファイル速度を一律に適用する（診療圏分析の標準的手法）。

### OSRMサーバの構築

Geofabrikから日本全土のOSMデータ（japan-latest.osm.pbf）をダウンロードし、以下の手順でOSRMの前処理を行う。

1. osrm-extract: PBFファイルからカスタムプロファイルで道路網を抽出する。
2. osrm-partition: MLDアルゴリズム用にグラフを分割する。
3. osrm-customize: 重みを計算する。

Docker Composeで localhost:5000 にOSRMサーバを起動する。max-table-size は 10000 に設定する。

### バッチ問い合わせ

OSRM table APIの1回の問い合わせに含められる座標数には上限がある。本プロジェクトでは、メッシュ（起点）を400件ずつのバッチに分割し、全施設（目的地）との所要時間行列を取得する。結果は秒単位の数値行列である。到達不能（null）の値は -1 として記録する。

---

## 8. 行政境界データ（GADM）

GADM（Global Administrative Areas）v4.1 の日本データ（gadm41_JPN_2.json）を使用する。GeoJSON形式で、NAME_1フィールドが都道府県名（英語）、NAME_2フィールドが市区町村名に対応する。各道県について、NAME_1でフィルタして市区町村のポリゴン集合を取得し、それらを結合（st_union）して道県境界を得る。

ライセンスは非商用・学術目的での使用が許可されている。

---

## 9. 出力データスキーマ

前処理パイプラインが出力するファイルは以下の通り。すべてdata/ディレクトリ配下に格納される。

### data/facilities.json

施設一覧のJSON配列。各要素は id, name, pref_code, pref_name, lat, lon のフィールドを持つ。

### data/prefectures.json

道県定義のJSON配列。各要素は code, name, name_en, dir_name のフィールドを持つ。dir_nameはデータサブディレクトリ名（例: "04_miyagi"）である。

### data/{code}_{name_en}/mesh.geojson

GeoJSON FeatureCollectionである。各Featureは1kmメッシュのポリゴンで、propertiesにmesh_code（メッシュコード）とpopulation（人口）を持つ。

### data/{code}_{name_en}/dur_matrix.json

所要時間行列のJSONオブジェクトである。colnamesフィールドが施設名の配列、dataフィールドが二次元数値配列（秒単位、整数に丸め）である。dataの行はmesh.geojsonのFeature順序に対応し、列はcolnamesの順序に対応する。到達不能の値は -1 で表す。

### data/{code}_{name_en}/muni.geojson

GeoJSON FeatureCollectionである。各Featureは市区町村のポリゴンで、propertiesにNAME_2（市区町村名）を持つ。

### data/{code}_{name_en}/border.geojson

GeoJSON FeatureCollectionである。道県の外縁を表す単一のFeature（市区町村ポリゴンの結合）で、propertiesにname（道県名）を持つ。

---

## 10. Webアプリケーション仕様

### 技術スタック

ブラウザ上で動作する静的Webアプリケーションである。外部ライブラリはLeaflet.js（v1.9.4）のみを使用する。ビルドツールやフレームワークは使用しない。

### 地図タイル

国土地理院の淡色地図タイルを使用する。URLテンプレートは以下の通り。

    https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png

帰属表示として「国土地理院」を表示する。

### 初期表示

地図の中心座標は北緯39.5度・東経141.0度、ズームレベル6とし、8道県全域が概観できるようにする。

### レイヤ構成

道県ごとに4つのLeaflet LayerGroupを持つ。

1. メッシュレイヤ: 1kmメッシュポリゴンを所要時間に応じて色分け表示する。
2. 市区町村境界レイヤ: 白色、線幅0.3、半透明で描画する。
3. 道県境界レイヤ: 灰色、線幅1.2で描画する。
4. 施設マーカーレイヤ: 有効な施設は黄色、無効な施設は灰色の丸マーカーで表示する。マーカーをクリックすると有効/無効が切り替わる。

### 時間帯分類と配色

所要時間（分）を以下の8区分に分類し、それぞれに色を割り当てる。

| 区分 | 範囲 | 色コード |
|------|------|---------|
| 15分以内 | 0-15 | #2166ac |
| 15-30分 | 15-30 | #4393c3 |
| 30-45分 | 30-45 | #92c5de |
| 45-60分 | 45-60 | #fddbc7 |
| 60-90分 | 60-90 | #f4a582 |
| 90-120分 | 90-120 | #d6604d |
| 120-180分 | 120-180 | #b2182b |
| 180分超 | 180- | #67001f |

この配色はRdBu（赤-青）ダイバージングカラースケールに基づく。

### サイドバー

画面左側にサイドバーを配置する。道県ごとの折りたたみセクションに施設チェックボックスを表示する。各道県セクションに全選択・全解除リンクを設け、サイドバー上部にもグローバルな全選択・全解除リンクを配置する。有効施設数をリアルタイムで表示する。

施設のチェック状態が変更されると、200ミリ秒のデバウンスを経てメッシュの色分けと集計テーブルが更新される。

### 集計テーブル

地図の下部に所要時間帯別の集計テーブルを表示する。列は時間帯・メッシュ数・人口・構成比（%）・累積（%）の5列である。構成比の背景にパーセンテージバーを表示する。

### 免責事項モーダル

初回表示時に免責事項モーダルを全面表示する。利用者が「上記の内容を理解し、同意のうえ利用します」チェックボックスをオンにすると「利用開始」ボタンが有効化され、クリックするとモーダルが非表示になる。モーダルにはデータの性質と限界、使用データの出典、免責事項を記載する。

### データ読み込み

起動時にprefectures.jsonとfacilities.jsonを読み込み、サイドバーを構築する。各道県のメッシュ・所要時間行列・境界データは並行して非同期に読み込む。

### 所要時間の計算

メッシュごとの最短アクセス時間は、そのメッシュが属する道県のdur_matrix.jsonから計算する。dur_matrix.jsonのcolnamesに含まれる施設のうち、現在有効な施設について最小値を求める。値は秒単位で格納されているため60で除して分に変換する。

---

## 11. 出典・ライセンス一覧

| データ | 出典 | ライセンス |
|--------|------|-----------|
| 人口メッシュ | 令和2年国勢調査（総務省統計局）、e-Stat | 政府統計の二次利用 |
| 道路ネットワーク | OpenStreetMap contributors | Open Database License (ODbL) |
| 経路計算エンジン | OSRM (Open Source Routing Machine) | BSD 2-Clause License |
| 行政境界 | GADM v4.1 | 非商用・学術目的 |
| 地図タイル | 国土地理院 | 出典明記により利用可 |
| 走行速度パラメータ | 松田ら (2018)「医療計画作成支援データブック」 | 学術引用 |
| ジオコーディング | Nominatim / OpenStreetMap | ODbL |

---

## 12. ディレクトリ構成

プロジェクトは以下の3つの領域に分かれる。

**公開対象（GitHub Pagesで配信）**: ルートのindex.html, app.js, style.css、およびdata/ディレクトリ。

**前処理パイプライン（非公開）**: preprocessing/ディレクトリ。R言語スクリプト群と施設マスタCSVを含む。

**OSRMセットアップ（非公開）**: osrm/ディレクトリ。Luaプロファイルとdocker-compose.ymlを含む。

raw_data/ディレクトリはダウンロードされた生データとOSRMバイナリを格納するが、gitignoreされる。

---

## 13. 前処理パイプラインの実行方法

Rの実行環境と以下のパッケージが必要である: sf, dplyr, httr, jsonlite。OSRMサーバがlocalhost:5000で起動している必要がある。

全道県を処理する場合はpreprocessing/run_all.Rを実行する。特定の道県のみを処理する場合は --pref オプションで道県コードを指定する。

パイプラインは4つのステップ（ダウンロード、OSRM計算、GADM抽出、JSON出力）を順次実行する。各ステップの中間結果はraw_data/estat/{code}/配下にRDSファイルとして保存されるため、特定のステップだけを再実行することも可能である。
